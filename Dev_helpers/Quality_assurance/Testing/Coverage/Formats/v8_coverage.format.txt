
               
   V8_COVERAGE  
               



GOAL ==>                          #Code instrumentation to produce coverage.
                                  #Done on V8 bytecode.
                                  #Fired from the debugger protocol API.

MODES ==>                         #Either:
                                  #  - "precise coverage": slow
                                  #  - "best efforts coverage": faster but imprecise (can lose information if function is
                                  #    out-of-scope and garbage collected)

DETAILS ==>                       #Includes:
                                  #  - function and branch hits, but not line hits
                                  #  - branches that were not hit
                                  #  - internal Node.js code
                                  #  - child processes, but not worker threads


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:             NODE              :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


ALTERNATIVES ==>                  #  - NODE_V8_COVERAGE (prefered): part of Node.js since 10.12
                                  #  - eywek v8-coverage:
                                  #     - run it using INSPECTOR core module
                                  #     - also does almost same as c8

ENVVAR NODE_V8_COVERAGE=DIR       #Record "precise coverage" information and save to DIR/coverage-PID-TIMESTAMP.json

COVERAGE                          #Content of the coverage file
COVERAGE.result                   #FILECOV_ARR, ordered by load start

FILECOV                           #Coverage of a special file
FILECOV.scriptId                  #Unique ID, incrementing 'INT'
FILECOV.url                       #'PATH'
FILECOV.functions                 #FUNCCOV_ARR

FUNCCOV                           #Coverage of a specific function
FUNCCOV.functionName              #FUNC.name
                                  #Can be '', including for top-level scope
FUNCCOV.ranges                    #LINECOV_ARR
FUNCCOV.isBlockCoverage           #BOOL. If false, branch covers the whole function, i.e. FUNCCOV.ranges === 1
                                  #Note that on the other hand, sometimes FUNCCOV.ranges === 1 but FUNCCOV.isBlockCoverage === true

BRANCHCOV                         #Coverage of a specific branch
BRANCHCOV.startOffset|endOffset   #Bytes offset inside the file
BRANCHCOV.count                   #NUM of times it was hit. Can be 0


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:        V8-TO-ISTANBUL         :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


VERSION ==>                      ##1.2.1

V8-TO-ISTANBUL('./SOURCE_FILE')
 ->CSCRIPT                       ##
CSCRIPT.applyCoverage(V8_FILECOV)##
CSCRIPT.toIstanbul()
 ->ISTANBUL_FILECOV              ##


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:              C8               :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


CONFIG ==>                       ##Either:
                                 ##  - CLI --OPT
                                 ##  - PACKAGE.c8 OBJ
                                 ##  - [.../].c8rc[.json]

c8 ...                           ##Run Node with ENVVAR NODE_V8_COVERAGE then run c8 report
--reporter|r 'FORMAT'
--exclude|x 'GLOB'
--include|n 'GLOB'               ##Like Istanbul, including defaults
--temp-directory PATH            ##Def: './coverage/tmp'
--[no-]clean                     ##BOOL (def: true). Remove temp-directory after run.
--resolve DIR                    ##Base directory for files
--[no-]omit-relative             ##Def: true

c8 report                        ##Do:
                                 ##  - merge all v8 coverage files in temp-directory
                                 ##  - resolve file paths according to --resolve
                                 ##  - use V8-TO-ISTANBUL() to convert to ISTANBUL_FILECOV
                                 ##  - use ISTANBUL-LIB-COVERAGE to convert to ISTANBUL_COVEMAP
                                 ##  - use ISTANBUL-LIB-REPORT to run reporter


                                             /=+===============================+=\
                                            /  :                               :  \
                                            )==:             MERGE             :==(
                                            \  :_______________________________:  /
                                             \=+===============================+=/


V8-COVERAGE-MERGE                ##Version 1.1.2
 (FILECOV, FILECOV2)->FILECOV    ##Merge two FILECOV with same url
